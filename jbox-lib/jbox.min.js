var jb=jb||{};function hexToRGB(e){return{r:parseInt(e.slice(1,3),16),g:parseInt(e.slice(3,5),16),b:parseInt(e.slice(5,7),16)}}jb._letters={A:[[,1],[1,,1],[1,1,1],[1,,1],[1,,1]],B:[[1,1],[1,,1],[1,1],[1,,1],[1,1]],C:[[,1,1],[1],[1],[1],[,1,1]],D:[[1,1],[1,,1],[1,,1],[1,,1],[1,1]],E:[[1,1,1],[1],[1,1],[1],[1,1,1]],F:[[1,1,1],[1],[1,1],[1],[1]],G:[[,1,1],[1],[1,,1],[1,,1],[,1,1]],H:[[1,,1],[1,,1],[1,1,1],[1,,1],[1,,1]],I:[[1,1,1],[,1],[,1],[,1],[1,1,1]],J:[[,,1],[,,1],[,,1],[1,,1],[1,1,1]],K:[[1,,1],[1,,1],[1,1],[1,,1],[1,,1]],L:[[1],[1],[1],[1],[1,1,1]],M:[[1,,1],[1,1,1],[1,1,1],[1,,1],[1,,1]],N:[[1,1],[1,,1],[1,,1],[1,,1],[1,,1]],O:[[,1,1],[1,,1],[1,,1],[1,,1],[1,1]],P:[[1,1],[1,,1],[1,1],[1],[1]],Q:[[0,1,1],[1,,1],[1,,1],[1,1,1],[,1,1]],R:[[1,1],[1,,1],[1,1],[1,,1],[1,,1]],S:[[,1,1],[1],[1,1,1],[,,1],[1,1]],T:[[1,1,1],[,1],[,1],[,1],[,1]],U:[[1,,1],[1,,1],[1,,1],[1,,1],[1,1,1]],V:[[1,,1],[1,,1],[1,,1],[1,,1],[,1]],W:[[1,,1],[1,,1],[1,,1],[1,1,1],[1,1,1]],X:[[1,,1],[1,,1],[,1],[1,,1],[1,,1]],Y:[[1,,1],[1,,1],[,1],[,1],[,1]],Z:[[1,1,1],[,,1],[,1],[1],[1,1,1]],0:[[1,1,1],[1,,1],[1,,1],[1,,1],[1,1,1]],1:[[1,1],[,1],[,1],[,1],[1,1,1]],2:[[1,1,1],[0,0,1],[1,1,1],[1,0,0],[1,1,1]],3:[[1,1,1],[0,0,1],[1,1,1],[0,0,1],[1,1,1]],4:[[1,0,1],[1,0,1],[1,1,1],[0,0,1],[0,0,1]],5:[[1,1,1],[1,0,0],[1,1,1],[0,0,1],[1,1,1]],6:[[1,1,1],[1,0,0],[1,1,1],[1,0,1],[1,1,1]],7:[[1,1,1],[0,0,1],[0,0,1],[0,0,1],[0,0,1]],8:[[1,1,1],[1,0,1],[1,1,1],[1,0,1],[1,1,1]],9:[[1,1,1],[1,0,1],[1,1,1],[0,0,1],[1,1,1]]," ":[[,,],[,,],[,,],[,,],[,,]],",":[[,,,],[,,,],[,,,],[,1,,],[1]],".":[[,,,],[,,,],[,,,],[,,,],[,1]],"!":[[1],[1],[1],[,],[1]],"?":[[1,1],[,,1],[,1],[,],[,1]],"(":[[,1],[1,,],[1,,],[1,,],[,1]],")":[[,1],[,,1],[,,1],[,,1],[,1]],"[":[[1,1],[1,,],[1,,],[1,,],[1,1]],"]":[[,1,1],[,,1],[,,1],[,,1],[,1,1]],"{":[[,1,1],[,1,,],[1,1],[,1,,],[,1,1]],"}":[[1,1],[,1],[,1,1],[,1],[1,1]],"'":[[1],[1],[,],[,],[,]],'"':[[1,,1],[1,,1],[,,],[,,],[,,]],"%":[[1,,1],[,,1],[,1],[1],[1,,1]],"&":[[1,1],[1,1],[1,1],[1,,1],[1,1,1]],"-":[[,,],[,,],[1,1,1],[,,],[,,]],"+":[[,],[,1],[1,1,1],[,1],[,]],"*":[[1,,1],[,1],[1,1,1],[,1],[1,,1]],"/":[[,,1],[,,1],[,1],[1,,],[1,,]],":":[[,,],[,1],[,,],[,1],[,,]],";":[[,,],[,1],[,,],[,1],[1,,]],_:[[,,],[,,],[,,],[,,],[1,1,1]]},jb._palette=["#fbf5ef","#f2d3ab","#c69fa5","#8b6d9c","#494d7e","#272744"],jb._screenSize=128,jb._transparent=5,jb.BTN_LEFT=0,jb.BTN_UP=1,jb.BTN_RIGHT=2,jb.BTN_DOWN=3,jb.BTN_A=4,jb.BTN_B=5,jb.BTN_START=6,jb.BTN_SELECT=7,jb._middleC=440*Math.pow(Math.pow(2,1/12),-9),jb._screenDataArray=new Uint8ClampedArray(65536),jb._cam={x:0,y:0},jb._keys={left:{pressed:!1,justPressed:!1},up:{pressed:!1,justPressed:!1},right:{pressed:!1,justPressed:!1},down:{pressed:!1,justPressed:!1},a:{pressed:!1,justPressed:!1},b:{pressed:!1,justPressed:!1},start:{pressed:!1,justPressed:!1},select:{pressed:!1,justPressed:!1}},jb._drawColor=0,jb._screenBuffer=null,jb._getClearScreenData=function(e){const t=new Uint8ClampedArray(65536);for(let s=0;s<65536;s+=4){const{r:r,g:i,b:a}=hexToRGB(this._palette[null!=e?e:this._transparent]);t[s]=r,t[s+1]=i,t[s+2]=a,t[s+3]=255}return t},jb.init=function(e){window.AudioContext=window.AudioContext||window.webkitAudioContext;this._jbcanv=document.createElement("canvas"),this._jbcanv.width=1*this._screenSize,this._jbcanv.height=1*this._screenSize,this._jbctx=this._jbcanv.getContext("2d"),this._jbctx.scale(1,1),this._actx=new AudioContext,this._jbctx.imageSmoothingEnabled=!1,document.body.appendChild(this._jbcanv),this._draw=e&&e.draw?e.draw:function(){},this._update=e&&e.update?e.update:function(){};const t=document.createElement("style");t.textContent="\n    * {\n      padding: 0;\n      margin: 0;\n      box-sizing: border-box;\n    }\n    body {\n      background-color: #000;\n    }\n\n    canvas {\n      display: block;\n      margin: 0 auto;\n      image-rendering: pixelated;\n      image-rendering: crisp-edges;\n    }\n  ",document.head.appendChild(t),this._fitToScreen(),this._screenBuffer=new ImageData(this._screenDataArray,128,128),window.addEventListener("resize",()=>this._fitToScreen()),window.addEventListener("keydown",e=>this._onKeyPressed(e)),window.addEventListener("keyup",e=>this._onKeyReleased(e)),window.requestAnimationFrame(e=>this._step(e)),e.init&&e.init()},jb._fitToScreen=function(){window.innerWidth>window.innerHeight?(this._jbcanv.style.height="100vh",this._jbcanv.style.width="auto"):(this._jbcanv.style.width="100vw",this._jbcanv.style.height="auto")},jb._step=function(e){this._lastFrame||(this._lastFrame=0);const t=e-this._lastFrame;this._frameRate=1e3/t,this._lastFrame=e,this._update(t/1e3),this._draw(),this._jbctx.putImageData(this._screenBuffer,0,0),window.requestAnimationFrame(e=>this._step(e))},jb.cls=function(e){const t=this._getClearScreenData(e);for(let e=0;e<t.length;e++)this._screenBuffer.data[e]=t[e]},jb.camera=function(e,t){this._cam={x:e,y:t}},jb.spr=function(e,t,s){const r=this._data.sprites.slice(64*e,64*(e+1)),{x:i,y:a}=this._adjustCoords(t,s);i>-8&&i<this._screenSize&&a>-8&&a<this._screenSize&&r.forEach((e,t)=>{const s=i+t%8,r=a+Math.floor(t/8);if(e!==this._transparent){const t=hexToRGB(this._palette[e]);this._updatePixel(s,r,t)}})},jb._updatePixel=function(e,t,{r:s,g:r,b:i}){if(this.isWithinScreenCoords(e,t)){const a=4*(128*t+e);a<this._screenBuffer.data.length-3&&(this._screenBuffer.data[a]=s,this._screenBuffer.data[a+1]=r,this._screenBuffer.data[a+2]=i,this._screenBuffer.data[a+3]=255)}},jb.color=function(e){e>=0&&e<this._palette.length&&(this._drawColor=e)},jb.print=function(e,t,s,r){const i=[],a="string"==typeof e?e.toUpperCase():e.toString().toUpperCase(),{x:n,y:o}=this._adjustCoords(t,s);for(let e=0;e<a.length;e++){const t=this._letters[a.charAt(e)];t&&i.push(t)}const c=hexToRGB(null!=r?this._palette[r]:this._palette[this._drawColor]);let h=0;i.forEach(e=>{let t=0,s=0;e.forEach(e=>{e.forEach((e,s)=>{e&&this._updatePixel(h+n+s,t+o,c)}),s=Math.max(s,e.length),t+=1}),h+=1+s})},jb.circ=function(e,t,s,r){jb._circ(e,t,s,r,!1)},jb._circ=function(e,t,s,r,i){const{x:a,y:n}=this._adjustCoords(e,t),o=hexToRGB(this._palette[null!=r?r:this._drawColor]);for(let e=-s;e<=s;e++)for(let t=-s;t<=s;t++){const r=t+a,c=e+n;if(i){if(t*t+e*e>=s*s)continue}else if(Math.abs(t*t+e*e-s*s)>s)continue;this._updatePixel(r,c,o)}},jb.circfill=function(e,t,s,r){jb._circ(e,t,s,r,!0)},jb.rect=function(e,t,s,r,i){this._rect(e,t,s,r,i,!1)},jb.rectfill=function(e,t,s,r,i){this._rect(e,t,s,r,i,!0)},jb._adjustCoords=function(e,t){return{x:Math.round(e-this._cam.x),y:Math.round(t-this._cam.y)}},jb._rect=function(e,t,s,r,i,a){e>s&&([e,s]=[s,e]),t>r&&([t,r]=[r,t]);const{x:n,y:o}=this._adjustCoords(e,t),{x:c,y:h}=this._adjustCoords(s,r),u=hexToRGB(null!=i?this._palette[i]:this._palette[this._drawColor]);if(a)for(let e=o;e<=h;e++)for(let t=n;t<=c;t++)this._updatePixel(t,e,u);else{for(let e=o;e<=h;e++)this._updatePixel(n,e,u),this._updatePixel(c,e,u);for(let e=n;e<=c;e++)this._updatePixel(e,o,u),this._updatePixel(e,h,u)}},jb.isWithinScreenCoords=function(e,t){return e>=0&&e<this._screenSize&&t>=0&&t<this._screenSize},jb.map=function(e,t){const s=8*Math.floor(e||0),r=8*Math.floor(t||0);for(let e=0;e<64;e++){const t=e%8,i=Math.floor(e/8);this._data.map.slice(256*e,256*(e+1)).forEach((e,a)=>{const n=a%16,o=Math.floor(a/16),c=s+128*t+8*n,h=r+128*i+8*o;c-this._cam.x<-8||c-this._cam.x>128||h-this._cam.y<-8||h-this._cam.y>128||this.spr(e,c,h)})}},jb.mget=function(e,t){if(e<0||t<0||e>128||t>128)return"";const s=Math.floor(e/16),r=Math.floor(t/16),i=Math.floor(e%16),a=8*r+s,n=16*Math.floor(t%16)+i,o=this._data.map[256*a+n];return null!=o?o:""},jb.fget=function(e,t){return e<0||e>63||t&&t<0||t&&t>7?null:t?this._data.spriteFlags[e]&1<<t:this._data.spriteFlags[e]},jb._resetKeys=function(){for(key in this._keys)this._keys[key].justPressed=!1},jb._onKeyPressed=function(e){switch(e.key.toLowerCase()){case"arrowup":this._keys.up.pressed=!0,this._keys.up.justPressed=!0;break;case"arrowdown":this._keys.down.pressed=!0,this._keys.down.justPressed=!0;break;case"arrowleft":this._keys.left.pressed=!0,this._keys.left.justPressed=!0;break;case"arrowright":this._keys.right.pressed=!0,this._keys.right.justPressed=!0;break;case"z":case"c":this._keys.a.pressed=!0,this._keys.a.justPressed=!0;break;case"x":this._keys.b.pressed=!0,this._keys.b.justPressed=!0;break;case"escape":this._keys.start.pressed=!0,this._keys.start.justPressed=!0;break;case"tab":this._keys.select.pressed=!0,this._keys.select.justPressed=!0}},jb._onKeyReleased=function(e){switch(e.key){case"ArrowUp":this._keys.up.pressed=!1;break;case"ArrowDown":this._keys.down.pressed=!1;break;case"ArrowLeft":this._keys.left.pressed=!1;break;case"ArrowRight":this._keys.right.pressed=!1;break;case"z":case"c":this._keys.a.pressed=!1;break;case"x":this._keys.b.pressed=!1;break;case"Escape":this._keys.start.pressed=!1;break;case"Tab":this._keys.select.pressed=!1}},jb.btn=function(e){switch(e){case 0:return this._keys.left.pressed;case 1:return this._keys.up.pressed;case 2:return this._keys.right.pressed;case 3:return this._keys.down.pressed;case 4:return this._keys.a.pressed;case 5:return this._keys.b.pressed;case 6:return this._keys.start.pressed;case 7:return this._keys.select.pressed}},jb.btnp=function(e){switch(e){case 0:return!!this._keys.left.justPressed&&(this._keys.left.justPressed=!1,!0);case 1:return!!this._keys.up.justPressed&&(this._keys.up.justPressed=!1,!0);case 2:return!!this._keys.right.justPressed&&(this._keys.right.justPressed=!1,!0);case 3:return!!this._keys.down.justPressed&&(this._keys.down.justPressed=!1,!0);case 4:return!!this._keys.a.justPressed&&(this._keys.a.justPressed=!1,!0);case 5:return!!this._keys.b.justPressed&&(this._keys.b.justPressed=!1,!0);case 6:return!!this._keys.start.justPressed&&(this._keys.start.justPressed=!1,!0);case 7:return!!this._keys.select.justPressed&&(this._keys.select.justPressed=!1,!0)}},jb._getFrequency=function(e,t=0){return freq=this._middleC*Math.pow(Math.pow(2,1/12),e),freq*Math.pow(2,t)},jb._soundEffect=function(e,t,s,r,i,a,n,o){void 0===t&&(t=200),void 0===s&&(s="sine"),void 0===r&&(r=1),void 0===i&&(i=0),void 0===a&&(a=2);const c=a/4,h=a,u=e.createOscillator(),d=e.createGain();switch(u.connect(d),d.connect(e.destination),u.type=s,u.frequency.value=t,d.gain.value=r,function(t){"fade-in"!==n&&(t.gain.value=0,t.gain.linearRampToValueAtTime(0,e.currentTime+i),t.gain.linearRampToValueAtTime(r,e.currentTime+i+.01));"fade-out"!==n&&(t.gain.linearRampToValueAtTime(r,e.currentTime+i+a-.01),t.gain.linearRampToValueAtTime(0,e.currentTime+i+a-.001))}(d),n){case"fade-in":(_=d).gain.value=0,_.gain.linearRampToValueAtTime(0,e.currentTime+i),_.gain.linearRampToValueAtTime(r,e.currentTime+i+c);break;case"fade-out":!function(t){t.gain.linearRampToValueAtTime(r,e.currentTime+i),t.gain.linearRampToValueAtTime(0,e.currentTime+i+h)}(d);break;case"vibrato":!function(s){const r=[];for(let e=0;e<a;e+=.01)r.push(t+Math.sin(40*e)*(t/40));s.setValueCurveAtTime(new Float32Array(r),e.currentTime+i,a)}(u.frequency);break;case"slide":!function(s){if(!o)return;const r=[t,o];s.setValueCurveAtTime(new Float32Array(r),e.currentTime+i,a)}(u.frequency)}var _,l;(l=u).start(e.currentTime+i),l.stop(e.currentTime+i+a)},jb.sfx=function(e){const t=this._data.sfx[e],s=t.tempo/64;for(let e=0;e<t.samples.length;e++){const r=t.samples[e];let i=1;if(!["fade-in","fade-out"].includes(r.fx))for(let s=e+1;s<t.samples.length;s++){const e=t.samples[s];if(!e||e.dist!==r.dist||e.type!==r.type||e.volume!==r.volume||e.fx!==r.fx)break;i++}this._soundEffect(this._actx,this._getFrequency(r.dist),r.type,r.volume/40,s*e,s*i,r.fx,t.samples[e+1]?this._getFrequency(t.samples[e+1].dist):null),e+=i-1}},jb._createImageData=function(){this._images=[];for(let e=0;e<64;e++){const t=this._data.sprites.slice(64*e,64*(e+1)).map(e=>{const t=this._palette[e],{r:s,g:r,b:i}=hexToRGB(t);return[s,r,i,e===this._transparent?0:255]}).flat(),s=new ImageData(new Uint8ClampedArray(t),8,8);this._images.push(s)}};